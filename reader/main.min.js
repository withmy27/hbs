pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.8.69/pdf.worker.min.mjs";const url=`https://withmy27.github.io/hbs/bulletins/${window.location.search.substring(1)??185}.pdf`,canvas1=document.querySelector("#can-1"),canvas2=document.querySelector("#can-2"),pageSlider=document.getElementById("page-slider"),prevBtn=document.getElementById("prev"),nextBtn=document.getElementById("next"),pageNumElem=document.getElementById("page-num"),loading=document.createElement("img");loading.src="hbs_logo.svg",loading.alt="hbs logo",loading.height="300px",loading.width="300px",loading.classList.add("loading");const minHeight=500,sqrt2=1.4142135624,revSqrt2=.7071067812,verticalMargin=80,horizontalMargin=24;let pdf=null,pdfMeta=null,currentPage=0,pageRendering=!1,pageNumPending=null,timerWindowSize=null,timerZoom=null,pagePerWindow=window.innerWidth>=800?2:1,scale=null,zoomLevel=1,pageHeight,pageWidth,viewPageHeight,viewPageWidth,isMouseOn=!1,password,renderTask1=null,renderTask2=null;async function start(){password=window.localStorage.getItem("pw");let e=pdfjsLib.getDocument({url,password:password,cMapUrl:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.8.69/cmaps/",disableFontFace:!0}).promise;try{pdf=await e}catch(a){console.log(a.message);for(let t=!0,r=!0;t&&("No password given"===a.message||"Incorrect Password"===a.message);){r?(password=prompt("비밀번호를 입력하세요."),r=!1):password=prompt("비밀번호가 맞지 않습니다.");let n=pdfjsLib.getDocument({url,password:password,cMapUrl:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.8.69/cmaps/",disableFontFace:!0}).promise;try{pdf=await n,t=!1,window.localStorage.setItem("pw",password)}catch(g){console.log(g.message);continue}}}console.log("start"),pdf.getPage(1).then(e=>{let a=e.getViewport({scale:1});pageWidth=a.width,pageHeight=a.height,pagePerWindow=pageWidth*(scale=(window.innerHeight-80)/pageHeight)*2<window.innerWidth?2:1,scale=pageWidth*scale<window.innerWidth?scale:(window.innerWidth-24)/pageWidth,pageSlider.max=pdf.numPages,renderPages(currentPage=2===pagePerWindow?0:1),prevBtn.addEventListener("click",onPrevPage),nextBtn.addEventListener("click",onNextPage),window.addEventListener("resize",()=>{clearTimeout(timerWindowSize),timerWindowSize=setTimeout(()=>{pdf.getPage(1).then(e=>{let a=e.getViewport({scale:1});pageWidth=a.width,pageHeight=a.height,pagePerWindow=pageWidth*(scale=(window.innerHeight-80)/pageHeight)*2<window.innerWidth?2:1,scale=pageWidth*scale<window.innerWidth?scale:(window.innerWidth-24)/pageWidth,2===pagePerWindow?currentPage-=1&currentPage:1===pagePerWindow&&0===currentPage&&(currentPage=1),pageSlider.max=pdf.numPages,renderPages(currentPage)})},300)}),window.onkeyup=e=>{"ArrowRight"===e.key||" "===e.key?(e.preventDefault(),onNextPage()):"ArrowLeft"===e.key&&(e.preventDefault(),onPrevPage())},pageSlider.addEventListener("input",e=>{if(pageRendering)return;let a=parseInt(e.target.value);1===pagePerWindow?(currentPage=a,pageNumElem.textContent=currentPage+" / "+pdf.numPages):2===pagePerWindow&&(currentPage=(1&a)==1?a-1:a,pageNumElem.textContent=currentPage+"-"+(currentPage!==pdf.numPages?currentPage+10:"END")+" / "+pdf.numPages),pageSlider.value=currentPage}),pageSlider.addEventListener("change",e=>{if(pageRendering)return;let a=parseInt(e.target.value);1===pagePerWindow?currentPage=a:2===pagePerWindow&&(currentPage=(1&a)==1?a-1:a),console.log(currentPage),renderPages(currentPage)}),window.visualViewport.addEventListener("resize",e=>{clearTimeout(timerZoom),timerZoom=setTimeout(()=>{zoomLevel=window.visualViewport.scale,renderPages(currentPage)},300)})})}async function renderSinglePage(e,a=1){if(pageRendering=!0,1===pagePerWindow?canvas2.style.display="none":canvas2.style.display="block",canvas1.style.display="block",0===e||e===pdf.numPages+1){let t=0===e?canvas1:canvas2,r=t.getContext("2d"),n=new Image,g=window.devicePixelRatio||1;t.width=Math.floor(pageWidth*g),t.height=Math.floor(1.4142135624*pageWidth*g),t.style.width=Math.floor(pageWidth*scale)+"px",t.style.height=Math.floor(1.4142135624*pageWidth*scale)+"px",n.src="./blank.jpg",n.addEventListener("load",()=>{r.drawImage(n,0,0,t.width,t.height),a===pagePerWindow&&(pageRendering=!1)}),1===pagePerWindow&&1===a?pageNumElem.textContent=e+" / "+pdf.numPages:2===pagePerWindow&&1===a&&(pageNumElem.textContent=`${e}-${e+1} / ${pdf.numPages}`);return}let i=1===a?canvas1:canvas2,d=i.getContext("2d");d.clearRect(0,0,i.width,i.height),d.resetTransform(),d.translate(0,0),d.rotate(0);let l=await pdf.getPage(e),o=l.getViewport({scale:scale*zoomLevel}),s=window.devicePixelRatio||1;i.width=Math.floor(o.width*s),i.height=Math.floor(o.height*s),i.style.width=Math.floor(o.width/zoomLevel)+"px",i.style.height=Math.floor(o.height/zoomLevel)+"px";let p={canvasContext:d,transform:1!==s?[s,0,0,s,0,0]:null,viewport:o};if(1===a?renderTask1=l.render(p):renderTask2=l.render(p),1===a&&(1===pagePerWindow?pageNumElem.textContent=e+" / "+pdf.numPages:2===pagePerWindow&&e===pdf.numPages?pageNumElem.textContent=`${e}-END / ${pdf.numPages}`:2===pagePerWindow&&(pageNumElem.textContent=`${e}-${e+1} / ${pdf.numPages}`)),1===a)try{await renderTask1.promise}catch(c){console.log(c)}else try{await renderTask2.promise}catch(u){console.log(u)}a===pagePerWindow&&(pageRendering=!1),1===a?renderTask1=null:renderTask2=null}async function renderPages(e){if(console.log("Render"),pageRendering){console.log("Rendering in renderPages");return}1===pagePerWindow?await renderSinglePage(e,1):2===pagePerWindow?(await renderSinglePage(e,1),await renderSinglePage(e+1,2)):console.log("What the heck?")}function onPrevPage(){if(pageRendering){console.log("Rendering...");return}if(currentPage<=(2===pagePerWindow?0:1)){console.log("Page staring");return}currentPage-=pagePerWindow,pageSlider.value=currentPage,renderPages(currentPage)}function onNextPage(){if(pageRendering){console.log("Rendering...");return}if(currentPage>=pdf.numPages){console.log("Page end");return}currentPage+=pagePerWindow,pageSlider.value=currentPage,renderPages(currentPage)}start();